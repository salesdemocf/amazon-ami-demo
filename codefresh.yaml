version: '1.0'
stages:
  - clone
  - build
  - deploy
steps:
  ClonePackerRepository:
    title: Cloning Packer repository...
    type: git-clone
    repo: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    git: github
    revision: ${{CF_REVISION}}
    stage: clone   
  CloneAnsibleRepository:
    title: Cloning Ansible repository...
    type: git-clone
    repo: dustinvanbuskirk/ansible-playbooks
    git: github
    revision: master
    stage: clone   
  CreatePackerImage:
    title: Creating AMI...
    image: dustinvanbuskirk/packer-ansible:1.6.0-2.9.7-r0
    working_directory: ${{ClonePackerRepository}}
    commands:
      - packer validate packer.json
      - packer build -var 'aws_access_key=${{AWS_ACCESS_KEY_ID}}' -var 'aws_secret_key=${{AWS_SECRET_ACCESS_KEY}}' packer.json
      - AMI_ID=$(jq -r '.builds[-1].artifact_id' manifest.json | cut -d ":" -f2) >> /meta/env_vars_to_export
    stage: build
    on_success: 
      annotations:
        set:
          - entity_id: ${{CF_BUILD_ID}}
            entity_type: build
            annotations:
            - amazon_ami: $AMI_ID
